#! @PYTHON@

#
# Copyright (C) 2008 Francesco Salvestrini
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#

import os
import sys
import traceback
import getopt
import pprint

from   Trace import *
from   DB    import *
from   Debug import *
from   Entry import *

def hint(s) :
    print(s)
    print("Use `" + PROGRAM_NAME + " -h' for help")

def usage() :
    print(PROGRAM_NAME + " OPTIONS")
    print("")
    print("  -a | --add [ARGS]         Add node")
    print("  -d | --database [ARG]     Change the database from the default to")
    print("                            the filename specified")
    print("  -r | --remove [ARGS]      Remove node (and its children)")
    print("  -e | --edit [ARGS]        Edit node")
    print("  -R | --reparent [ARGS]    Reparent node (and its children)")
    print("  -s | --show [ARGS]        Show")
    print("  -v | --verbose            Enable debug mode")
    print("  -h | --help               This help")
    print("")
    print("Report bugs to <@PACKAGE_BUGREPORT@>")

def version() :
    print(PROGRAM_NAME + " (" + PACKAGE_NAME + ") " + PACKAGE_VERSION)

DEFAULT_SOURCE_FILE = ".todo"

def do_add(database, args) :
    return 1

def do_remove(database, args) :
    filter = None

    if (filter == None) :
        raise Exception("filter is empty")

    return 1

def do_edit(database, args) :
    return 1

def do_reparent(database, args) :
    return 1

def do_show(database, args) :
    # Load DB
    db   = DB()
    tree = db.load(database)

    class Visitor :
        def visit(self, e) :
            debug("Visiting entry " + str(e))
            for j in e.children() :
                assert(j != None)
                self.visit(j)

    v = Visitor()
    tree.accept(v)

    return 0

def main(args) :
    # Parse command line
    try :
	opts, args = getopt.getopt(args[1:],
				   "a:d:r:e:R:svh",
				   [ "add=",
				     "database=",
                                     "remove=",
				     "edit=",
				     "reparent=",
				     "show",
				     "help",
				     "version" ])
    except getopt.GetoptError :
	hint("Parameter(s) error")
	return 1

    source    = DEFAULT_SOURCE_FILE
    do_action = do_show
    parms     = []
    for opt, arg in opts :
	if opt in ("-a", "--add") :
	    do_action = do_add ;      parms  = args[2:]
	elif opt in ("-d", "--database") :
	    source = arg
	elif opt in ("-r", "--remove") :
	    do_action = do_remove ;   parms  = args[2:]
	elif opt in ("-e", "--edit") :
	    do_action = do_edit ;     parms  = args[2:]
	elif opt in ("-r", "--reparent") :
	    do_action = do_reparent ; parms  = args[2:]
	elif opt in ("-s", "--show") :
	    do_action = do_show ;     parms  = args[2:]
	elif opt in ("-h", "--help") :
	    usage()
	    return 0
	elif opt in ("-v", "--version") :
	    version()
	    return 0
	else :
	    bug()

    if (do_action == None) :
	hint("Missing parameter(s)")
	return 1

    try :
        retval = do_action(source, parms)
    except IOError, e :
        error(e.value)
    except ValueError, e :
        error(e.value)
    except :
        bug()
        return 1

    return retval

if (__name__ == '__main__') :
    sys.exit(main(sys.argv))
